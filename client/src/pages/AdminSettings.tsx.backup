import { useState, useEffect } from "react";
import { trpc } from "@/lib/trpc";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Textarea } from "@/components/ui/textarea";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Settings, Upload, Loader2, Image as ImageIcon } from "lucide-react";
// Storage will be handled via tRPC endpoint

export default function AdminSettings() {
  const [siteName, setSiteName] = useState("");
  const [siteTagline, setSiteTagline] = useState("");
  const [logoUrl, setLogoUrl] = useState("");
  const [logoFile, setLogoFile] = useState<File | null>(null);
  const [logoPreview, setLogoPreview] = useState<string | null>(null);
  const [uploadingLogo, setUploadingLogo] = useState(false);

  const { data: config, isLoading } = trpc.site.getConfig.useQuery();
  const updateMutation = trpc.site.updateConfig.useMutation({
    onSuccess: () => {
      alert("Configurações salvas com sucesso!");
    },
    onError: (error) => {
      alert(`Erro: ${error.message}`);
    },
  });

  useEffect(() => {
    if (config) {
      setSiteName(config.siteName || "");
      setSiteTagline(config.siteTagline || "");
      setLogoUrl(config.logoUrl || "");
      setLogoPreview(config.logoUrl || null);
    }
  }, [config]);

  const handleLogoChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (file) {
      if (!file.type.startsWith("image/")) {
        alert("Por favor, selecione apenas imagens");
        return;
      }

      setLogoFile(file);

      // Create preview
      const reader = new FileReader();
      reader.onloadend = () => {
        setLogoPreview(reader.result as string);
      };
      reader.readAsDataURL(file);
    }
  };

  const uploadLogo = async () => {
    if (!logoFile) return logoUrl;

    setUploadingLogo(true);

    try {
      // For now, use base64 data URL directly
      // In production, you would upload to storage here
      const reader = new FileReader();
      const base64Promise = new Promise<string>((resolve) => {
        reader.onloadend = () => resolve(reader.result as string);
        reader.readAsDataURL(logoFile);
      });

      const base64 = await base64Promise;
      
      setUploadingLogo(false);
      return base64;
    } catch (error) {
      console.error("Upload error:", error);
      alert("Erro ao fazer upload do logo");
      setUploadingLogo(false);
      return logoUrl;
    }
  };

  const handleSave = async () => {
    let finalLogoUrl = logoUrl;

    // Upload logo if changed
    if (logoFile) {
      finalLogoUrl = await uploadLogo();
    }

    updateMutation.mutate({
      siteName,
      siteTagline: siteTagline || undefined,
      logoUrl: finalLogoUrl || undefined,
    });
  };

  if (isLoading) {
    return (
      <div className="container mx-auto py-8 text-center">
        <Loader2 className="w-8 h-8 animate-spin mx-auto" />
      </div>
    );
  }

  return (
    <div className="container mx-auto py-8 max-w-4xl">
      <Card>
        <CardHeader>
          <CardTitle className="flex items-center gap-2">
            <Settings className="w-6 h-6" />
            Configurações do Site
          </CardTitle>
          <CardDescription>
            Personalize as informações e aparência do seu site
          </CardDescription>
        </CardHeader>
        <CardContent className="space-y-6">
          {/* Logo Upload */}
          <div className="space-y-2">
            <Label htmlFor="logo">Logo do Site</Label>
            <div className="flex items-center gap-4">
              <div className="flex-1">
                <Input
                  id="logo"
                  type="file"
                  accept="image/*"
                  onChange={handleLogoChange}
                />
              </div>
              {logoPreview && (
                <div className="w-32 h-32 rounded-lg overflow-hidden border bg-muted flex items-center justify-center">
                  <img
                    src={logoPreview}
                    alt="Logo preview"
                    className="max-w-full max-h-full object-contain"
                  />
                </div>
              )}
              {!logoPreview && (
                <div className="w-32 h-32 rounded-lg border bg-muted flex items-center justify-center">
                  <ImageIcon className="w-8 h-8 text-muted-foreground" />
                </div>
              )}
            </div>
            <p className="text-xs text-muted-foreground">
              Recomendado: PNG transparente, 200x200px
            </p>
          </div>

          {/* Site Name */}
          <div className="space-y-2">
            <Label htmlFor="siteName">Nome do Site</Label>
            <Input
              id="siteName"
              value={siteName}
              onChange={(e) => setSiteName(e.target.value)}
              placeholder="Lirolla"
            />
          </div>

          {/* Site Tagline */}
          <div className="space-y-2">
            <Label htmlFor="siteTagline">Slogan / Tagline</Label>
            <Textarea
              id="siteTagline"
              value={siteTagline}
              onChange={(e) => setSiteTagline(e.target.value)}
              placeholder="Capturando momentos únicos e transformando-os em arte atemporal"
              rows={3}
            />
          </div>

          {/* Current Logo URL (readonly) */}
          {logoUrl && !logoFile && (
            <div className="space-y-2">
              <Label>URL do Logo Atual</Label>
              <Input value={logoUrl} readOnly className="text-xs text-muted-foreground" />
            </div>
          )}

          {/* Save Button */}
          <Button
            onClick={handleSave}
            disabled={updateMutation.isPending || uploadingLogo}
            className="w-full"
            size="lg"
          >
            {uploadingLogo ? (
              <>
                <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                Fazendo upload do logo...
              </>
            ) : updateMutation.isPending ? (
              <>
                <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                Salvando...
              </>
            ) : (
              "Salvar Configurações"
            )}
          </Button>

          {/* Info */}
          <div className="bg-muted p-4 rounded-lg text-sm space-y-2">
            <p className="font-semibold">ℹ️ Informações:</p>
            <ul className="list-disc list-inside space-y-1 text-muted-foreground">
              <li>O logo aparecerá no cabeçalho do site</li>
              <li>O nome do site é usado no título das páginas</li>
              <li>O slogan aparece na página inicial</li>
              <li>Alterações são aplicadas imediatamente</li>
            </ul>
          </div>
        </CardContent>
      </Card>
    </div>
  );
}
